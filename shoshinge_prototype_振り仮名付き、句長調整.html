<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>正信偈アプリ (ルビ表示対応版)</title>
  <style>
    body {
      font-family: "Hiragino Mincho ProN", "MS Mincho", serif;
      margin: 0;
      padding: 20px;
      background: white;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      box-sizing: border-box;
    }

    h1 {
      text-align: center;
      margin-bottom: 15px;
    }

    #controlsContainer {
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f8f8f8;
    }

    #modeSelector {
      margin-bottom: 10px;
      text-align: center;
    }

    #modeSelector button {
      margin: 0 5px;
      padding: 8px 15px;
      font-size: 16px;
      cursor: pointer;
      border: 1px solid #ccc;
      background-color: #fff;
      border-radius: 4px;
      transition: background-color 0.2s, border-color 0.2s;
    }

    #modeSelector button:hover {
      background-color: #eee;
    }

    #modeSelector button.active {
      font-weight: bold;
      background-color: #e0e0e0;
      border-color: #bbb;
    }

    #playbackControls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #playbackControls button {
      padding: 5px 10px;
      font-size: 18px;
      cursor: pointer;
      border: 1px solid #ccc;
      background-color: #fff;
      border-radius: 4px;
      width: 40px;
      text-align: center;
    }

    #playbackControls button:hover {
      background-color: #eee;
    }

    #playbackControls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #progressBarContainer {
      flex-grow: 1;
      height: 12px;
      background: #ccc;
      border-radius: 6px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }

    #progressBar {
      width: 0%;
      height: 100%;
      background: #4caf50;
      transition: width 0.1s linear;
    }

    #pagesContainer {
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 300px;
    }


    .page {
      writing-mode: vertical-rl;
      text-orientation: upright;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: space-evenly;
      height: 75vh;
      max-height: 600px;
      width: 90%;
      max-width: 500px;
      font-size: 26px;
      /* 親文字のサイズ */
      padding: 20px;
      border: 1px solid #eee;
      border-radius: 5px;
      box-sizing: border-box;
    }

    .page.active {
      display: flex;
    }

    .verse {
      padding: 8px 0;
      /* ルビの分、少し余白を広げる */
      border-radius: 3px;
      text-align: center;
      line-height: 1.8;
      /* ルビ表示のため行間を少し広げる */
      cursor: pointer;
      transition: background-color 0.2s ease;
      /* background-color: rgba(255,0,0,0.1); */
      /* デバッグ用 */
    }

    .verse:hover {
      background-color: #f0f0f0;
    }

    /* --- ルビ表示のためのスタイル --- */
    .verse {
      padding: 8px 0;
      border-radius: 3px;
      /* text-align: center; */
      /* ← ruby要素がflexになったので不要かも */
      line-height: 1.8;
      /* 親要素の行間はそのまま */
      cursor: pointer;
      transition: background-color 0.2s ease;

      /* ▼▼▼ 追加/変更 ▼▼▼ */
      display: flex;
      /* Flexbox を使用 */
      flex-direction: column;
      /* 縦書きなので、中の要素を縦に並べる */
      justify-content: center;
      /* 主軸（縦）方向の中央揃え */
      align-items: center;
      /* 交差軸（横）方向の中央揃え */
      min-height: calc(26px * 7 * 1.2);
      /* 親文字サイズ×文字数×行間の目安 (要調整) */
      /* 26px は .page の font-size */
      /* 1.2 は余裕を持たせた係数 (ルビも考慮) */
      /* この値は実際の表示を見ながら調整してください */
      /* background-color: rgba(0, 255, 0, 0.1); */
      /* デバッグ用 */
    }

    .verse ruby {
      display: ruby;
      /* line-height: 1; */
      /* ruby要素自体の行間は1で良いかも */
      text-align: center;
      /* これは漢字とルビの横方向の位置関係に影響 */
    }

    .verse rt {
      font-size: 0.5em;
      color: #333;
      ruby-position: over;
      ruby-align: center;
    }

    /* ----------------------------- */

    .highlight ruby {
      /* ハイライト時は背景色のみ変更 */
      background-color: #ffeb3b;
      display: inline-block;
      /* 背景色を付けるために必要かも */
      padding: 2px 4px;
      /* 背景色のパディング */
      border-radius: 3px;
    }

    /* ハイライト時のテキスト色は不要なら削除 */
    /* .highlight ruby rb,
    .highlight ruby rt {
        color: black;
    } */
  </style>
</head>

<body>

  <h1>正信偈・念仏和讃</h1>

  <div id="controlsContainer">
    <div id="modeSelector">
      <button id="btn-shoshinge" onclick="switchMode('shoshinge')" class="active">正信偈</button>
      <button id="btn-wasan" onclick="switchMode('wasan')">念仏和讃</button>
    </div>

    <div id="playbackControls">
      <button id="playBtn" title="再生">▶️</button>
      <button id="pauseBtn" title="一時停止">⏸️</button>
      <div id="progressBarContainer" title="クリックして再生位置を変更">
        <div id="progressBar"></div>
      </div>
    </div>
  </div>

  <audio id="audio" src="audio/shoshinge.mp3"></audio>

  <div id="pagesContainer"></div>

  <script>
    // --- 要素の取得 (変更なし) ---
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressBar = document.getElementById('progressBar');
    const pagesContainer = document.getElementById('pagesContainer');
    const modeButtons = {
      shoshinge: document.getElementById('btn-shoshinge'),
      wasan: document.getElementById('btn-wasan')
    };

    // --- 状態変数 (変更なし) ---
    let currentMode = 'shoshinge';
    let pages = [];
    let currentActivePage = null;

    // --- 音声ファイルのパス定義 (変更なし) ---
    const audioFiles = {
      shoshinge: 'audio/shoshinge.mp3',
      wasan: 'audio/nenbutuwasan.mp3'
    };

    // --- 句のデータ ★★★ ここに ruby プロパティを追加 ★★★ ---
    // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
    // ★ 全ての句に正しい振り仮名を 'ruby:' の後に追加してください ★
    // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
    const originalPagesData = [
      // --- 正信偈 (shoshinge) ---
      // 最初の数行にダミーのルビを入れています
      {
        section: 'shoshinge', verses: [
          { start: 7.1, end: 21.9, text: '帰命無量寿如来', ruby: 'きみょうむりょうじゅにょらい' },
          { start: 21.9, end: 30.9, text: '南無不可思議光', ruby: 'なむふかしぎこう' },
          { start: 30.9, end: 38.7, text: '法蔵菩薩因位時', ruby: 'ほうぞうぼさついんにじ' },
          { start: 38.7, end: 46.0, text: '在世自在王仏所', ruby: 'ざいせいじざいおうぶっしょ' }
        ]
      },
      // 以下、ruby プロパティを追加 (値は空文字列か、正しいルビを入れてください)
      { section: 'shoshinge', verses: [{ start: 46.0, end: 53.0, text: '覩見諸仏浄土因', ruby: 'とけんしょぶつじょうどいん' }, { start: 53.0, end: 59.9, text: '国土人天之善悪', ruby: 'こくどにんでんしぜんまく' }, { start: 59.9, end: 66.9, text: '建立無上殊勝願', ruby: 'こんりゅうむじょうしゅしょうがん' }, { start: 66.9, end: 73.4, text: '超発希有大弘誓', ruby: 'ちょうほつけーうだいぐぜい' }] },
      { section: 'shoshinge', verses: [{ start: 73.4, end: 80.1, text: '五劫思惟之摂受', ruby: 'ごこうしゆいししょうじゅ' }, { start: 80.1, end: 86.9, text: '重誓名声聞十方', ruby: 'じゅうせいみょうしょうもんじっぽう' }, { start: 86.9, end: 93.7, text: '普放無量無辺光', ruby: 'ふほうむりょうむへんこう' }, { start: 93.7, end: 100.4, text: '無碍無対光炎王', ruby: 'むげむたいこうえんのう' }] },
      // ... (以下、全ての句データに ruby: '...' を追加) ...
      // 正信偈の残りのデータ (ruby を追加)
      { section: 'shoshinge', verses: [{ start: 100.4, end: 107.0, text: '清浄歓喜智慧光', ruby: 'しょうじょうかんぎちえこう' }, { start: 107.0, end: 113.7, text: '不断難思無称光', ruby: 'ふだんなんじむしょうこう' }, { start: 113.7, end: 120.2, text: '超日月光照塵刹', ruby: 'ちょうにちがっこうしょうじんせつ' }, { start: 120.2, end: 126.8, text: '一切群生蒙光照', ruby: 'いっさいぐんじょうむこうしょう' }] },
      { section: 'shoshinge', verses: [{ start: 126.8, end: 133.3, text: '本願名号正定業', ruby: 'ほんがんみょうごうしょうじょうごう' }, { start: 133.3, end: 140.0, text: '至心信楽願為因', ruby: 'ししんしんぎょうがんにいん' }, { start: 140.0, end: 146.5, text: '成等覚証大涅槃', ruby: 'じょうとうがくしょうだいねはん' }, { start: 146.5, end: 153.0, text: '必至滅度願成就', ruby: 'ひっしめつどがんじょうじゅ' }] },
      { section: 'shoshinge', verses: [{ start: 153.0, end: 159.3, text: '如来所以興出世', ruby: 'にょらいしょいこうしゅっせ' }, { start: 159.3, end: 165.9, text: '唯説弥陀本願海', ruby: 'ゆいせつみだほんがんかい' }, { start: 165.9, end: 172.3, text: '五濁悪時群生海', ruby: 'ごじょくあくじぐんじょうかい' }, { start: 172.3, end: 178.7, text: '応信如来如実言', ruby: 'おんしんにょらいにょじつごん' }] },
      { section: 'shoshinge', verses: [{ start: 178.7, end: 185.0, text: '能発一念喜愛心', ruby: 'のうほついちねんきあいしん' }, { start: 185.0, end: 191.4, text: '不断煩悩得涅槃', ruby: 'ふだんぼんじょうとくねはん' }, { start: 191.4, end: 197.7, text: '凡聖逆謗斉廻入', ruby: 'ぼんじょうぎゃくほうさいえにゅう' }, { start: 197.7, end: 204.2, text: '如衆水入海一味', ruby: 'にょしゅうすいにゅうかいいちみ' }] },
      { section: 'shoshinge', verses: [{ start: 204.2, end: 210.6, text: '摂取心光常照護', ruby: 'せっしゅしんこうじょうしょうご' }, { start: 210.6, end: 217.1, text: '已能雖破無明闇', ruby: 'いのうすいはむみょうあん' }, { start: 217.1, end: 223.5, text: '貪愛瞋憎之雲霧', ruby: 'とんないしんぞうしうんむ' }, { start: 223.5, end: 229.7, text: '常覆真実信心天', ruby: 'じょうふしんじつしんじんてん' }] },
      { section: 'shoshinge', verses: [{ start: 229.7, end: 236.0, text: '譬如日光覆雲霧', ruby: 'にょらいにっこうふうんむ' }, { start: 236.0, end: 242.7, text: '雲霧之下明無闇', ruby: 'うんむしげみょうむあん' }, { start: 242.7, end: 248.7, text: '獲信見敬大慶喜', ruby: 'ぎゃくしんけんきょうだいきょうき' }, { start: 248.7, end: 254.9, text: '即横超截五悪趣', ruby: 'そくおうちょうぜつごあくしゅ' }] },
      { section: 'shoshinge', verses: [{ start: 254.9, end: 261.1, text: '一切善悪凡夫人', ruby: 'いっさいぜんあくぼんぶにん' }, { start: 261.1, end: 267.4, text: '聞信如来弘誓願', ruby: 'もんしんにょらいくぜいがん' }, { start: 267.4, end: 273.7, text: '仏言広大勝解者', ruby: 'ぶつごんこうだいしょうげしゃ' }, { start: 273.7, end: 279.9, text: '是人名分陀利華', ruby: 'ぜにんみょうふんだりけ' }] },
      { section: 'shoshinge', verses: [{ start: 279.9, end: 285.9, text: '弥陀仏本願念仏', ruby: 'みだぶつほんがんねんぶつ' }, { start: 285.9, end: 292.1, text: '邪見驕慢悪衆生', ruby: 'じゃけんきょうまんなくしゅじょう' }, { start: 292.1, end: 298.3, text: '信楽受持甚以難', ruby: 'しんぎょうじゅじじんになん' }, { start: 298.3, end: 304.4, text: '難中之難無過斯', ruby: 'なんちゅうしなんむかし' }] },
      { section: 'shoshinge', verses: [{ start: 304.4, end: 310.6, text: '印度西天之論家', ruby: 'いんどさいてんしろんげ' }, { start: 310.6, end: 319.8, text: '中夏日域之高僧', ruby: 'ちゅうかじちいきしこうそう' }, { start: 319.8, end: 325.8, text: '顕大聖興世正意', ruby: 'けんだいしょうこうせしょうい' }, { start: 325.8, end: 331.9, text: '明如来本誓応機', ruby: 'みょうにょらいほんぜいおうき' }] },
      { section: 'shoshinge', verses: [{ start: 331.9, end: 338.1, text: '釈迦如来楞伽山', ruby: 'しゃかにょらいりょうがせん' }, { start: 338.1, end: 347.2, text: '為衆告命南天竺', ruby: 'いしゅうごうみょうなんてんじく' }, { start: 347.2, end: 353.3, text: '龍樹大士出於世', ruby: 'りゅうじゅだいじしゅっとせ' }, { start: 353.3, end: 359.3, text: '悉能摧破有無見', ruby: 'しつのうざいはうむけん' }] },
      { section: 'shoshinge', verses: [{ start: 359.3, end: 365.3, text: '宣説大乗無上法', ruby: 'せんぜつだいじょうむじょうほう' }, { start: 365.3, end: 371.3, text: '証歓喜地生安楽', ruby: 'しょうかんぎじしょうあんらく' }, { start: 371.3, end: 377.3, text: '顕示難行陸路苦', ruby: 'けんじなんぎょうろくろく' }, { start: 377.3, end: 383.4, text: '信楽易行水道楽', ruby: 'しんぎょういぎょうしいどうらく' }] },
      { section: 'shoshinge', verses: [{ start: 383.4, end: 389.5, text: '憶念弥陀仏本願', ruby: 'おくねんみだほんがんかい' }, { start: 389.5, end: 398.6, text: '自然即時入必定', ruby: 'じねんそくじにゅうひつじょう' }, { start: 398.6, end: 404.7, text: '唯能常称如来号', ruby: 'ゆいのうじょうしょうにょらいごう' }, { start: 404.7, end: 410.7, text: '応報大悲弘誓恩', ruby: 'おうほうだいひぐぜいがん' }] },
      { section: 'shoshinge', verses: [{ start: 410.7, end: 416.7, text: '天親菩薩造論説', ruby: 'てんじんぼさつぞうろんせつ' }, { start: 416.7, end: 422.9, text: '帰命無碍光如来', ruby: 'きみょうむげこうにょらい' }, { start: 422.9, end: 429.0, text: '依修多羅顕真実', ruby: 'えしゅうたらけんしんじつ' }, { start: 429.0, end: 434.9, text: '光闡横超大誓願', ruby: 'こうせんおうちょうだいせいがん' }] },
      { section: 'shoshinge', verses: [{ start: 434.9, end: 440.8, text: '広由本願力回向', ruby: 'こうゆほんがんりきえこう' }, { start: 440.8, end: 447.1, text: '為度群生彰一心', ruby: 'いどぐんじょうしょういっしん' }, { start: 447.1, end: 453.1, text: '帰入功徳大宝海', ruby: 'きにゅうくどくだいほうかい' }, { start: 453.1, end: 459.2, text: '必獲入大会衆数', ruby: '筆逆にゅうだいえしゅしゅう' }] },
      { section: 'shoshinge', verses: [{ start: 459.2, end: 465.2, text: '得至蓮華蔵世界', ruby: 'とくしれんげぞうせいかい' }, { start: 465.2, end: 471.2, text: '即証真如法性身', ruby: 'そくしょうしんにょほっしょうじん' }, { start: 471.2, end: 477.2, text: '遊煩悩林現神通', ruby: 'ゆうぼんのうりんげんじんずう' }, { start: 477.2, end: 483.1, text: '入生死園示応化', ruby: 'にゅうしょうじおんじおうげ' }] },
      { section: 'shoshinge', verses: [{ start: 483.1, end: 489.1, text: '本師曇鸞梁天子', ruby: 'ほんしどんらんりょうてんし' }, { start: 489.1, end: 495.3, text: '常向鸞処菩薩礼', ruby: 'じょうこうらんしょぼさつらい' }, { start: 495.3, end: 501.3, text: '三蔵流支授浄教', ruby: 'さんぞうるしじゅじょうきょう' }, { start: 501.3, end: 507.2, text: '焚焼仙経帰楽邦', ruby: 'ぼんじょうせんぎょうきらくほう' }] },
      { section: 'shoshinge', verses: [{ start: 507.2, end: 513.2, text: '天親菩薩論註解', ruby: 'てんじんぼつさろんちゅうげ' }, { start: 513.2, end: 519.2, text: '報土因果顕誓願', ruby: 'ほうどいんがけんせいがん' }, { start: 519.2, end: 525.1, text: '往還回向由他力', ruby: 'おうげんねこうゆたりき' }, { start: 525.1, end: 531.1, text: '正定之因唯信心', ruby: 'しょうじょうしいんゆいしんじん' }] },
      { section: 'shoshinge', verses: [{ start: 531.1, end: 537.1, text: '惑染凡夫信心発', ruby: 'わくぜんぼんぶしんじんぽつ' }, { start: 537.1, end: 543.2, text: '証知生死即涅槃', ruby: 'しょうちしょうじそくねはん' }, { start: 543.2, end: 549.3, text: '必至無量光明土', ruby: 'ひっしむりょうこうみょうど' }, { start: 549.3, end: 555.3, text: '諸有衆生皆普化', ruby: 'しょうしゅじょうかいふけ' }] },
      { section: 'shoshinge', verses: [{ start: 555.3, end: 561.3, text: '道綽決聖道難証', ruby: 'どうしゃっけっしょうどうなんしょう' }, { start: 561.3, end: 567.5, text: '唯明浄土可通入', ruby: 'ゆいみょうじょうどかつうにゅう' }, { start: 567.5, end: 573.6, text: '万善自力貶勤修', ruby: 'まんぜんじりきへんごんしゅう' }, { start: 573.6, end: 579.5, text: '円満徳号勧専称', ruby: 'えんまんとくごうかんせんしょう' }] },
      { section: 'shoshinge', verses: [{ start: 579.5, end: 585.3, text: '三不三信誨慇懃', ruby: 'さんぷさんしんけおんごん' }, { start: 585.3, end: 591.5, text: '像末法滅同悲引', ruby: 'ぞうまつほうめつどうひいん' }, { start: 591.5, end: 597.8, text: '一生造悪値弘誓', ruby: 'いっしょうぞうあくちぐぜい' }, { start: 597.8, end: 612.5, text: '至安養界証妙果', ruby: 'しあんにょうがいしょうみょうか' }] },
      { section: 'shoshinge', verses: [{ start: 612.5, end: 628.3, text: '善導独明仏正意', ruby: 'ぜんどうどくみょうぶっしょうい' }, { start: 628.3, end: 637.4, text: '矜哀定散与逆悪', ruby: 'こうあいじょうさんよぎゃくあく' }, { start: 637.4, end: 645.5, text: '光明名号顕因縁', ruby: 'こうみょうみょうごうけんいんねんし' }, { start: 645.5, end: 652.7, text: '開入本願大智海', ruby: 'かいにゅうほんがんだいちかい' }] },
      { section: 'shoshinge', verses: [{ start: 652.7, end: 659.6, text: '行者正受金剛心', ruby: 'ぎょうじゃしょうじゅこんごうしん' }, { start: 659.6, end: 666.4, text: '慶喜一念相応後', ruby: 'きょうきいちねんそうおうご' }, { start: 666.4, end: 673.1, text: '与韋提等獲三忍', ruby: 'よいだいとうぎゃくさんにん' }, { start: 673.1, end: 679.9, text: '即証法性之常楽', ruby: 'そくしょうほっしょうしじょうらく' }] },
      { section: 'shoshinge', verses: [{ start: 679.9, end: 686.5, text: '源信広開一代教', ruby: 'げんしんこうかいいちだいきょう' }, { start: 686.5, end: 693.2, text: '偏帰安養勧一切', ruby: 'へんきあんにょうかんいっさい' }, { start: 693.2, end: 699.8, text: '専雑執心判浅深', ruby: 'せんぞうしゅうしんはんせんじん' }, { start: 699.8, end: 706.4, text: '報化二土正弁立', ruby: 'ほうけにどししょうべんりゅう' }] },
      { section: 'shoshinge', verses: [{ start: 706.4, end: 712.9, text: '極重悪人唯称仏', ruby: 'ごくじゅうあくにんゆいしょうぶつ' }, { start: 712.9, end: 719.4, text: '我亦在彼摂取中', ruby: 'がやくざいひせっしゅちゅう' }, { start: 719.4, end: 725.8, text: '煩悩障眼雖不見', ruby: 'ぼんのうしょうげんすいふけん' }, { start: 725.8, end: 732.2, text: '大悲無倦常照我', ruby: 'だいひむけんじょうしょうが' }] },
      { section: 'shoshinge', verses: [{ start: 732.2, end: 738.7, text: '本師源空明仏教', ruby: 'ほんしげんくうみょうぶっきょう' }, { start: 738.7, end: 745.1, text: '憐愍善悪凡夫人', ruby: 'れんみんぜんあくぼんぶにん' }, { start: 745.1, end: 751.7, text: '真宗教証興片州', ruby: 'しんしゅうきょうしょうこうへんしゅう' }, { start: 751.7, end: 757.9, text: '選択本願弘悪世', ruby: 'せんじゃくほんがんぐあくせい' }] },
      { section: 'shoshinge', verses: [{ start: 757.9, end: 764.3, text: '還来生死輪転家', ruby: 'げんらいしょうじりんでんげ' }, { start: 764.3, end: 770.9, text: '決以疑情為所止', ruby: 'けっちぎじょういしょし' }, { start: 770.9, end: 777.3, text: '速入寂静無為楽', ruby: 'そくにゅうじゃくじょうむいらく' }, { start: 777.3, end: 784.8, text: '必以信心為能入', ruby: 'ひっちしんじんいのうにゅう' }] },
      { section: 'shoshinge', verses: [{ start: 784.8, end: 796.5, text: '弘経大士宗師等', ruby: 'ぐきょうだいじしゅうしとう' }, { start: 797.3, end: 809.2, text: '拯済無辺極濁悪', ruby: 'じょうさいむへんごくじょくあく' }, { start: 809.2, end: 821.1, text: '道俗時衆共同心', ruby: 'どうぞくじしゅうぐどうしん' }, { start: 821.1, end: 827.0, text: '唯可信斯高僧説', ruby: 'ゆいかしんしこうそうせつ' }] },
      // --- 念仏和讃 (wasan) ---
      // ダミールビ
      {
        section: 'wasan', verses: [
          { start: 3.9, end: 12, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' },
          { start: 12, end: 21.4, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' },
          { start: 21.4, end: 29.7, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' },
          { start: 29.7, end: 37.7, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }
        ]
      },
      // 以下、ruby プロパティを追加 (値は空文字列か、正しいルビを入れてください)
      { section: 'wasan', verses: [{ start: 37.7, end: 45.9, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 45.9, end: 54.3, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 54.3, end: 56.8, text: '南', ruby: 'な' }, { start: 56.8, end: 75.6, text: '彌陀成佛のこのかたは', ruby: 'みだじょうぶつのこのかたは' }] },
      { section: 'wasan', verses: [{ start: 75.6, end: 92, text: 'いまに十劫をへたまへり', ruby: 'いまにじっこうをへたまえり' }, { start: 92, end: 102.3, text: '法身の光輪きはもなく', ruby: 'ほっしんのこうりんきはもなく' }, { start: 108.7, end: 121.4, text: '世の盲冥をてらすなり', ruby: 'せのもうみょうをてらすなり' }, { start: 121.5, end: 129.5, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }] },
      { section: 'wasan', verses: [{ start: 129.5, end: 137.2, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 137.2, end: 145.2, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 145.2, end: 153.4, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 153.4, end: 155.9, text: '南', ruby: 'な' }] },
      { section: 'wasan', verses: [{ start: 155.9, end: 173.7, text: '智慧の光明はかりなし', ruby: 'ちえのこうみょうはかりなし' }, { start: 173.7, end: 187.8, text: '有量の諸相ことごとく', ruby: 'うりょうのしょそうことごとく' }, { start: 187.8, end: 203.2, text: '光暁かぶらぬものはなし', ruby: 'こうけうかむらなものはなし' }, { start: 203.2, end: 215.5, text: '眞實明に帰命せよ', ruby: 'しんじつみょうにきみょうせよ' }] },
      { section: 'wasan', verses: [{ start: 215.5, end: 223.3, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 223.3, end: 231.3, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 231.3, end: 239, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 239, end: 246.7, text: '南無', ruby: 'なも' }] },
      { section: 'wasan', verses: [{ start: 246.7, end: 256.7, text: '阿弥陀仏', ruby: 'あみだーんぶ' }, { start: 256.7, end: 264.5, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 264.5, end: 272, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 272, end: 280.4, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }] },
      { section: 'wasan', verses: [{ start: 280.4, end: 287.6, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 287.6, end: 295, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 295, end: 302.6, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 302.6, end: 305.2, text: '南', ruby: 'な' }] },
      { section: 'wasan', verses: [{ start: 305.2, end: 326.5, text: '解脱の光輪きはもなし', ruby: 'げだつのこうりんきわもなく' }, { start: 326.5, end: 340.2, text: '光触かぶるものはみな', ruby: 'こうそくかむらぬものはなし' }, { start: 340.2, end: 353.2, text: '有無をはなるとのべたまふ', ruby: 'うむをはなるとのべたもう' }, { start: 353.2, end: 365.5, text: '平等覚に帰命せよ', ruby: 'びょうどうかくにきみょうせよ' }] },
      { section: 'wasan', verses: [{ start: 365.5, end: 372.9, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 372.9, end: 380.9, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 380.9, end: 387.9, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 387.9, end: 395.2, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }] },
      { section: 'wasan', verses: [{ start: 395.2, end: 398.1, text: '南', ruby: 'な' }, { start: 398.1, end: 418.2, text: '光雲無碍如虚空', ruby: 'こうみょうむげにょこくう' }, { start: 418.2, end: 427.4, text: '一切の有碍にさはりなし', ruby: 'いっさいのうげにさわりなし' }, { start: 427.8, end: 445.3, text: '光沢かふらぬものぞなき', ruby: 'こうたくかむらぬものはなし' }] },
      { section: 'wasan', verses: [{ start: 445.4, end: 457.3, text: '難思議を帰命せよ', ruby: 'なんじぎをきみょうせよ' }, { start: 457.3, end: 464.8, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 464.8, end: 471.8, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 471.8, end: 483.2, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }] },
      { section: 'wasan', verses: [{ start: 483.2, end: 495.4, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 495.4, end: 504.3, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 504.3, end: 512.3, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 512.3, end: 520.6, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }] },
      { section: 'wasan', verses: [{ start: 520.6, end: 528.5, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 528.5, end: 536.1, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 536.1, end: 544.3, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 544.3, end: 546.5, text: '南', ruby: 'な' }] },
      { section: 'wasan', verses: [{ start: 546.5, end: 567.6, text: '清浄光明ならびなし', ruby: 'しょうじょうこうみょうならびなし' }, { start: 567.6, end: 581.4, text: '遇斯光のゆへなれば', ruby: 'くしこうのゆえなれば' }, { start: 581.4, end: 597.3, text: '一切の業繋ものぞこりぬ', ruby: 'いっさいのごうけものぞこりぬ' }, { start: 597.3, end: 610, text: '畢竟依を帰命せよ', ruby: 'ひっきょうえをきみょうせよ' }] },
      { section: 'wasan', verses: [{ start: 610, end: 617.7, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 617.7, end: 625.5, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 625.5, end: 633.2, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }, { start: 633.2, end: 641.4, text: '南無阿弥陀仏', ruby: 'なもあみだーんぶ' }] },
      { section: 'wasan', verses: [{ start: 641.4, end: 643.7, text: '南', ruby: 'な' }, { start: 643.7, end: 660.5, text: '佛光照曜最第一', ruby: 'ぶっこうせうえうさいだいいち' }, { start: 660.5, end: 676.2, text: '光炎王仏となづけたり', ruby: 'こうえんのうぶっとなづけたり' }, { start: 676.2, end: 690.2, text: '三塗の黒闇ひらくなり', ruby: 'さんずのこくあんひらくなり' }] },
      { section: 'wasan', verses: [{ start: 690.2, end: 703.4, text: '大応供を帰命せよ', ruby: 'だいおうぐをきみょうせよ' }, { start: 704.4, end: 722.8, text: '願以此功徳', ruby: 'がんにしくどく' }, { start: 722.8, end: 733.5, text: '平等施一切', ruby: 'びょうどうせいっさい' }, { start: 733.5, end: 743.9, text: '同発菩提心', ruby: 'どうほつぼだいしん' }] },
      { section: 'wasan', verses: [{ start: 743.9, end: 755.0, text: '往生安楽国', ruby: 'おうじょうあんらっこく' }] },
    ];

    // --- 関数定義 ---

    /**
     * ページ要素をデータに基づいて生成し、コンテナに追加する (★ ルビ対応 ★)
     */
    function createPageElement(pageData) {
      const pageDiv = document.createElement('div');
      pageDiv.classList.add('page');
      pageDiv.dataset.section = pageData.section;

      pageData.verses.forEach(verseData => {
        const verseDiv = document.createElement('div');
        verseDiv.classList.add('verse');
        verseDiv.dataset.start = verseData.start;
        verseDiv.dataset.end = verseData.end;

        // --- <ruby> タグを生成 ---
        const rubyElement = document.createElement('ruby');
        const rbElement = document.createElement('rb'); // 親文字 (漢字)
        rbElement.textContent = verseData.text;
        const rtElement = document.createElement('rt'); // ルビ (振り仮名)
        // ruby データがあれば設定、なければ空にする
        rtElement.textContent = verseData.ruby || ''; // ★ ruby プロパティを参照

        rubyElement.appendChild(rbElement);
        rubyElement.appendChild(rtElement);
        verseDiv.appendChild(rubyElement); // verseDiv の中に ruby 要素を入れる
        // --- ここまで <ruby> タグ生成 ---

        // 句をクリックしたらその開始時間にシークするイベントリスナー
        verseDiv.addEventListener('click', () => {
          if (!isNaN(verseData.start) && audio.duration) {
            audio.currentTime = verseData.start;
            if (audio.paused) {
              audio.play().catch(e => console.error("Error playing on verse click:", e));
            }
          }
        });
        pageDiv.appendChild(verseDiv);
      });
      return pageDiv;
    }

    /**
     * アプリケーションの初期化 (変更なし)
     */
    function initialize() {
      pagesContainer.innerHTML = '';
      pages = [];
      originalPagesData.forEach(pageData => {
        const pageElement = createPageElement(pageData);
        pagesContainer.appendChild(pageElement);
        pages.push(pageElement);
      });
      switchMode(currentMode, true);
      playBtn.addEventListener('click', playAudio);
      pauseBtn.addEventListener('click', pauseAudio);
      audio.addEventListener('timeupdate', handleTimeUpdate);
      audio.addEventListener('loadedmetadata', handleLoadedMetadata);
      audio.addEventListener('ended', handleAudioEnded);
      audio.addEventListener('error', handleAudioError);
      progressBarContainer.addEventListener('click', handleProgressBarClick);
      playBtn.disabled = false;
      pauseBtn.disabled = true;
      console.log("Application initialized.");
    }

    /**
     * モード切り替え (変更なし)
     */
    function switchMode(mode, isInitialLoad = false) {
      if (!isInitialLoad && currentMode === mode) return;
      console.log(`Switching mode to: ${mode}`);
      currentMode = mode;
      currentActivePage = null;

      Object.values(modeButtons).forEach(btn => btn.classList.remove('active'));
      if (modeButtons[mode]) modeButtons[mode].classList.add('active');

      const newAudioSrc = audioFiles[mode];
      const currentFileName = audio.currentSrc.substring(audio.currentSrc.lastIndexOf('/') + 1);
      const newFileName = newAudioSrc.substring(newAudioSrc.lastIndexOf('/') + 1);

      if (isInitialLoad || currentFileName !== newFileName) {
        audio.pause();
        audio.src = newAudioSrc;
        audio.load();
        audio.currentTime = 0;
        progressBar.style.width = '0%';
        playBtn.disabled = false;
        pauseBtn.disabled = true;
        console.log(`Audio source set to: ${newAudioSrc}`);
      }

      const firstPageOfMode = pages.find(p => p.dataset.section === mode);
      pages.forEach(p => {
        p.style.display = 'none';
        p.classList.remove('active');
        p.querySelectorAll('.verse.highlight').forEach(v => v.classList.remove('highlight'));
      });
      if (firstPageOfMode) {
        firstPageOfMode.style.display = 'flex';
        firstPageOfMode.classList.add('active');
        currentActivePage = firstPageOfMode;
        console.log("Showing first page of mode:", mode);
      } else {
        console.warn("No pages found for mode:", mode);
      }
      // モード切替時はハイライトをリセット
      highlightVerse(0);
      updateActivePage(null); // 初期ページ表示を確実にする
    }

    /**
     * 現在時刻に基づいて句をハイライト (★ ハイライト対象を <ruby> 要素に変更 ★)
     */
    function highlightVerse(currentTime) {
      let highlightedVerseElement = null; // ハイライトされた .verse 要素
      let highlightedRubyElement = null;  // ハイライトされた <ruby> 要素

      pages.forEach(p => {
        if (p.dataset.section === currentMode) {
          // このページ内の既存のハイライトを全て解除 (ruby 要素から highlight クラスを削除)
          p.querySelectorAll('.verse ruby.highlight').forEach(r => r.classList.remove('highlight'));
          // 句を走査
          p.querySelectorAll('.verse').forEach(v => {
            const start = parseFloat(v.dataset.start);
            const end = parseFloat(v.dataset.end);
            const rubyElement = v.querySelector('ruby'); // ruby 要素を取得

            if (rubyElement && !isNaN(start) && !isNaN(end) && currentTime >= start && currentTime < end) {
              rubyElement.classList.add('highlight'); // <ruby> 要素にハイライトを適用
              highlightedVerseElement = v; // 親の .verse 要素も記録
              highlightedRubyElement = rubyElement;
            }
          });
        } else {
          // 非表示モードのページのハイライトも解除
          p.querySelectorAll('.verse ruby.highlight').forEach(r => r.classList.remove('highlight'));
        }
      });
      // updateActivePage には親の .verse 要素を渡す
      return highlightedVerseElement;
    }

    /**
     * アクティブなページを更新 (変更なし、highlightVerseから渡される要素で判定)
     */
    function updateActivePage(highlightedVerseElement) {
      let pageToShow = null;

      if (highlightedVerseElement) {
        pageToShow = pages.find(p => p.dataset.section === currentMode && p.contains(highlightedVerseElement));
      }

      if (!pageToShow) {
        if (!audio.paused) {
          pageToShow = currentActivePage;
        } else {
          pageToShow = pages.find(p => p.dataset.section === currentMode);
          if (audio.currentTime > 0) {
            const pageAtCurrentTime = pages.find(p => {
              if (p.dataset.section !== currentMode) return false;
              const verses = p.querySelectorAll('.verse');
              const firstVerseStart = verses.length > 0 ? parseFloat(verses[0].dataset.start) : NaN;
              const lastVerseEnd = verses.length > 0 ? parseFloat(verses[verses.length - 1].dataset.end) : NaN;
              return !isNaN(firstVerseStart) && !isNaN(lastVerseEnd) && audio.currentTime >= firstVerseStart && audio.currentTime < lastVerseEnd;
            });
            if (pageAtCurrentTime) pageToShow = pageAtCurrentTime;
          }
        }
      }

      pages.forEach(p => {
        if (p === pageToShow) {
          if (!p.classList.contains('active')) {
            p.style.display = 'flex';
            p.classList.add('active');
          }
          currentActivePage = p;
        } else {
          p.style.display = 'none';
          p.classList.remove('active');
        }
      });
    }


    // --- イベントハンドラ (変更なし) ---
    function playAudio() {
      const playPromise = audio.play();
      if (playPromise !== undefined) {
        playPromise.then(_ => {
          playBtn.disabled = true; pauseBtn.disabled = false; console.log("Audio playback started.");
        }).catch(error => {
          console.error("Audio playback failed:", error); alert("音声の再生を開始できませんでした。"); playBtn.disabled = false; pauseBtn.disabled = true;
        });
      } else { playBtn.disabled = true; pauseBtn.disabled = false; }
    }
    function pauseAudio() { audio.pause(); playBtn.disabled = false; pauseBtn.disabled = true; console.log("Audio playback paused."); }
    function handleTimeUpdate() { if (audio.duration) { progressBar.style.width = (audio.currentTime / audio.duration) * 100 + '%'; } const highlightedVerseElement = highlightVerse(audio.currentTime); updateActivePage(highlightedVerseElement); }
    function handleLoadedMetadata() { console.log("Audio metadata loaded. Duration:", audio.duration, "Src:", audio.currentSrc); progressBar.style.width = '0%'; playBtn.disabled = false; pauseBtn.disabled = true; }
    function handleAudioEnded() { console.log("Audio ended."); playBtn.disabled = false; pauseBtn.disabled = true; }
    function handleAudioError(e) { console.error("Audio Error:", audio.error, "Src:", audio.currentSrc); const err = audio.error; let message = `音声ファイルの読み込み/再生に失敗しました。\nファイル: ${audio.currentSrc.split('/').pop()}`; if (err) { message += `\nエラーコード: ${err.code}`; switch (err.code) { case MediaError.MEDIA_ERR_ABORTED: message += ' (読み込み中止)'; break; case MediaError.MEDIA_ERR_NETWORK: message += ' (ネットワークエラー)'; break; case MediaError.MEDIA_ERR_DECODE: message += ' (デコードエラー)'; break; case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED: message += ' (ファイル形式非対応/ファイルが見つからない)'; break; default: message += ' (不明なエラー)'; } } alert(message); playBtn.disabled = true; pauseBtn.disabled = true; }
    function handleProgressBarClick(e) { if (!audio.duration || !isFinite(audio.duration)) { console.warn("Cannot seek: Audio duration not available or invalid."); return; } const rect = progressBarContainer.getBoundingClientRect(); const offsetX = e.clientX - rect.left; const newTime = (offsetX / rect.width) * audio.duration; if (isFinite(newTime)) { audio.currentTime = newTime; console.log(`Seeked to: ${newTime.toFixed(2)}s`); const highlightedVerseElement = highlightVerse(audio.currentTime); updateActivePage(highlightedVerseElement); progressBar.style.width = (audio.currentTime / audio.duration) * 100 + '%'; } else { console.warn("Cannot seek: Calculated time is not finite.", newTime); } }

    // --- アプリケーション初期化実行 ---
    document.addEventListener('DOMContentLoaded', initialize);

  </script>

</body>

</html>