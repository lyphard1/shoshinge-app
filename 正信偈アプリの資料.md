# 正信偈アプリ プロジェクト資料

## 1. 概要

このプロジェクトは、「正信偈」および「念仏和讃」の音声とテキストを同期させて表示するWebアプリケーションです。主な機能として、音声の再生に合わせて対応する句がハイライトされ、関連する画像が表示されます。

## 2. プロジェクト構成

### 2.1. ファイル構成

```
shoshinge-app/
├── shoshinge_prototype.html  # メインのアプリケーションファイル
├── readme.md                 # プロジェクトの説明ファイル
├── 正信偈アプリの資料.md       # この資料ファイル
├── image/                    # 表示用画像フォルダ
│   ├── 帰命無量寿如来.png
│   └── ... (多数の画像ファイル)
└── audio/                    # 音声ファイルフォルダ
    ├── shoshinge.mp3
    └── nenbutuwasan.mp3
```

### 2.2. 主要ファイル

- **`shoshinge_prototype.html`**
  - アプリケーションのすべてのロジック（HTML, CSS, JavaScript）を含んでいます。
  - ユーザーインターフェースの定義、句のデータ、音声再生ロジック、画像切り替え機能などが記述されています。

- **`image/` フォルダ**
  - 正信偈および和讃の各ページに対応する画像が格納されています。
  - ファイル名は、表示される句の内容に関連付けられています。

- **`audio/` フォルダ**
  - 再生用の音声ファイル（MP3形式）が格納されています。

## 3. 主な機能と実装

### 3.1. モード切替
- 「正信偈」と「念仏和讃」の2つのモードをボタンで切り替えることができます。
- モードを切り替えると、対応する音声とテキスト、画像セットが読み込まれます。

### 3.2. 音声とテキストの同期
- JavaScript内の `originalPagesData` という配列に、各句のテキスト、ルビ（ふりがな）、および音声ファイル内での開始・終了時刻（タイムスタンプ）がページごとに定義されています。
- `audio` 要素の `timeupdate` イベントを利用して、現在の再生時刻を常に監視しています。
- 再生時刻が特定の句のタイムスタンプの範囲内にある場合、その句の `<div>` 要素に `.highlight` クラスを付与し、背景色を変更してハイライト表示します。

### 3.3. 画像表示
- JavaScript内の `imageFiles` というオブジェクトに、各モード（正信偈・和讃）で表示する画像のファイル名リストがページ順に定義されています。
- `highlightVerse` 関数内で、現在ハイライトされている句がどのページに属するかを判定し、そのページのインデックスに対応する画像を表示します。
- これにより、ページが切り替わるタイミングで画像も連動して更新されます。

### 3.4. ページ構成
- 句は縦書きで表示され、ページごとに定義された句数で1ページを構成します。
- 音声の進行に合わせて、アクティブなページが自動的に切り替わって表示されます。

## 4. 開発・実行環境

### 4.1. 実行方法
- VS Codeの拡張機能「Live Server」を利用して `shoshinge_prototype.html` を開くことで、ローカル環境でアプリケーションを動作させることができます。
  1. `shoshinge_prototype.html` をエディタで開く。
  2. 右クリックし、「Open with Live Server」を選択する。
  3. ブラウザが起動し、アプリケーションが表示されます。


### 4.2. 音声ファイルの変換
- `m4a` 形式の音声ファイルを `mp3` に変換する際は、`ffmpeg` を使用しました。
  ```sh
  # 例: m4a から mp3 への変換コマンド
  ffmpeg -i input.m4a -codec:a libmp3lame -qscale:a 3 output.mp3
  ```

## 5. 収録経文・和讃

### 5.1. 正信念仏偈

> **Page 1**
> 帰命無量寿如来
> 南無不可思議光
> 法蔵菩薩因位時
> 在世自在王仏所
>
> **Page 2**
> 覩見諸仏浄土因
> 国土人天之善悪
> 建立無上殊勝願
> 超発希有大弘誓
>
> **Page 3**
> 五劫思惟之摂受
> 重誓名声聞十方
> 普放無量無辺光
> 無碍無対光炎王
>
> **Page 4**
> 清浄歓喜智慧光
> 不断難思無称光
> 超日月光照塵刹
> 一切群生蒙光照
>
> **Page 5**
> 本願名号正定業
> 至心信楽願為因
> 成等覚証大涅槃
> 必至滅度願成就
>
> **Page 6**
> 如来所以興出世
> 唯説弥陀本願海
> 五濁悪時群生海
> 応信如来如実言
>
> **Page 7**
> 能発一念喜愛心
> 不断煩悩得涅槃
> 凡聖逆謗斉廻入
> 如衆水入海一味
>
> **Page 8**
> 摂取心光常照護
> 已能雖破無明闇
> 貪愛瞋憎之雲霧
> 常覆真実信心天
>
> **Page 9**
> 譬如日光覆雲霧
> 雲霧之下明無闇
> 獲信見敬大慶喜
> 即横超截五悪趣
>
> **Page 10**
> 一切善悪凡夫人
> 聞信如来弘誓願
> 仏言広大勝解者
> 是人名分陀利華
>
> **Page 11**
> 弥陀仏本願念仏
> 邪見驕慢悪衆生
> 信楽受持甚以難
> 難中之難無過斯
>
> **Page 12**
> 印度西天之論家
> 中夏日域之高僧
> 顕大聖興世正意
> 明如来本誓応機
>
> **Page 13**
> 釈迦如来楞伽山
> 為衆告命南天竺
> 龍樹大士出於世
> 悉能摧破有無見
>
> **Page 14**
> 宣説大乗無上法
> 証歓喜地生安楽
> 顕示難行陸路苦
> 信楽易行水道楽
>
> **Page 15**
> 憶念弥陀仏本願
> 自然即時入必定
> 唯能常称如来号
> 応報大悲弘誓恩
>
> **Page 16**
> 天親菩薩造論説
> 帰命無碍光如来
> 依修多羅顕真実
> 光闡横超大誓願
>
> **Page 17**
> 広由本願力回向
> 為度群生彰一心
> 帰入功徳大宝海
> 必獲入大会衆数
>
> **Page 18**
> 得至蓮華蔵世界
> 即証真如法性身
> 遊煩悩林現神通
> 入生死園示応化
>
> **Page 19**
> 本師曇鸞梁天子
> 常向鸞処菩薩礼
> 三蔵流支授浄教
> 焚焼仙経帰楽邦
>
> **Page 20**
> 天親菩薩論註解
> 報土因果顕誓願
> 往還回向由他力
> 正定之因唯信心
>
> **Page 21**
> 惑染凡夫信心発
> 証知生死即涅槃
> 必至無量光明土
> 諸有衆生皆普化
>
> **Page 22**
> 道綽決聖道難証
> 唯明浄土可通入
> 万善自力貶勤修
> 円満徳号勧専称
>
> **Page 23**
> 三不三信誨慇懃
> 像末法滅同悲引
> 一生造悪値弘誓
> 至安養界証妙果
>
> **Page 24**
> 善導独明仏正意
> 矜哀定散与逆悪
> 光明名号顕因縁
> 開入本願大智海
>
> **Page 25**
> 行者正受金剛心
> 慶喜一念相応後
> 与韋提等獲三忍
> 即証法性之常楽
>
> **Page 26**
> 源信広開一代教
> 偏帰安養勧一切
> 専雑執心判浅深
> 報化二土正弁立
>
> **Page 27**
> 極重悪人唯称仏
> 我亦在彼摂取中
> 煩悩障眼雖不見
> 大悲無倦常照我
>
> **Page 28**
> 本師源空明仏教
> 憐愍善悪凡夫人
> 真宗教証興片州
> 選択本願弘悪世
>
> **Page 29**
> 還来生死輪転家
> 決以疑情為所止
> 速入寂静無為楽
> 必以信心為能入
>
> **Page 30**
> 弘経大士宗師等
> 拯済無辺極濁悪
> 道俗時衆共同心
> 唯可信斯高僧説

### 5.2. 念仏和讃

> **Page 1**
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
>
> **Page 2**
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南
>
> **Page 3**
> 彌陀成佛のこのかたは
> いまに十劫をへたまへり
> 法身の光輪きはもなく
> 世の盲冥をてらすなり
>
> **Page 4**
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南
>
> **Page 5**
> 智慧の光明はかりなし
> 有量の諸相ことごとく
> 光暁かぶらぬものはなし
> 眞實明に帰命せよ
>
> **Page 6**
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無
>
> **Page 7**
> 阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
>
> **Page 8**
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南
>
> **Page 9**
> 解脱の光輪きはもなし
> 光触かぶるものはみな
> 有無をはなるとのべたまふ
> 平等覚に帰命せよ
>
> **Page 10**
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南
>
> **Page 11**
> 光雲無碍如虚空
> 一切の有碍にさはりなし
> 光沢かふらぬものぞなき
> 難思議を帰命せよ
>
> **Page 12**
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
>
> **Page 13**
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
>
> **Page 14**
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南
>
> **Page 15**
> 清浄光明ならびなし
> 遇斯光のゆえなれば
> 一切の業繋ものぞこりぬ
> 畢竟依を帰命せよ
>
> **Page 16**
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南無阿弥陀仏
> 南
>
> **Page 17**
> 佛光照曜最第一
> 光炎王仏となづけたり
> 三塗の黒闇ひらくなり
> 大応供を帰命せよ
>
> **Page 18**
> 願以此功徳
> 平等施一切
> 同発菩提心
> 往生安楽国

## 6. 技術的実装詳細

### 6.1. UI/UX改善実装（2025/08/27追加）

#### ページ高さ固定機能
```javascript
function computeFixedPageHeight() {
  const pagesOfMode = pages.filter(p => p.dataset.section === currentMode);
  let maxH = 0;
  // 全ページを一時表示して高さ計測
  pagesOfMode.forEach(p => {
    p.style.height = 'auto'; // 自然高さで計測
    const h = p.offsetHeight;
    if (h > maxH) maxH = h;
  });
  // CSS変数に最大高さを設定
  document.documentElement.style.setProperty('--page-fixed-height', `${maxH}px`);
}
```

#### 句束の中央寄せ
```css
.page {
  height: var(--page-fixed-height, 420px); /* 最長ページ高さで固定 */
  justify-content: flex-start; /* 上寄せで余白削減 */
}

.pageInner {
  display: flex;
  flex-direction: column;
  align-items: center; /* 句（縦書き）を束として中央に */
  width: max-content;
  margin-left: auto;
  margin-right: auto; /* ページ内で中央配置 */
}
```

### 6.2. 動的高さ調整の仕組み
1. **計測フェーズ**: 各モードの全ページを非表示状態で計測
2. **CSS変数設定**: `--page-fixed-height` に最大高さを格納
3. **リサイズ対応**: ウィンドウリサイズ時とモード切替時に再計測
4. **句束中央配置**: `.pageInner` ラッパーで句数に関係なく中央寄せ

### 6.3. 順番ハイライト機能の実装（2025/08/28追加）

#### ハイライト方式の変更
```javascript
function highlightVerse(currentTime) {
  // 全てのハイライトを一旦解除
  pages.forEach(p => {
    p.querySelectorAll('.verse.highlight').forEach(v => v.classList.remove('highlight'));
    p.querySelectorAll('.char.highlight-char').forEach(c => c.classList.remove('highlight-char'));
  });

  // 現在の句をハイライト
  if (highlightedVerseElement) {
    highlightedVerseElement.classList.add('highlight');

    // 文字単位ハイライト
    const chars = Array.from(highlightedVerseElement.querySelectorAll('rb .char:not(.char-ruby)'));
    if (chars.length > 0) {
      const charDuration = verseDuration / chars.length;
      const charIndex = Math.floor(elapsedTime / charDuration);
      if (charIndex >= 0 && charIndex < chars.length) {
        chars[charIndex].classList.add('highlight-char');
      }
    }
  }
}
```

#### 文字ハイライトのスタイル変更
```css
.verse .char.highlight-char {
  color: #007bff; /* 青色文字ハイライト */
  background: transparent;
  border-radius: 0;
  box-shadow: none;
  transform: none;
}
```

#### 機能の特徴
1. **同時ハイライト**: 句の背景ハイライト + 文字の色変更ハイライト
2. **リアルタイム追従**: 音声の進行に合わせて文字が順番にハイライト
3. **既読句クリア**: 毎回全てのハイライトをクリアしてから現在の句のみハイライト
4. **シンプルUI**: 切り替えボタン不要で常に機能有効

### 6.4. コード最適化の詳細（2025/08/28追加）

#### 削除されたデバッグコード
- `createPageElement()` 内の文字要素作成時のログ出力
- `switchMode()` 内のモード切替ログ
- `playAudio()`, `pauseAudio()` 内の再生状態ログ
- `clearAllHighlights()` 内の詳細ログ

#### 改善された関数
- `handleTimeUpdate()`, `handleLoadedMetadata()`, `handleAudioEnded()`, `handleAudioError()`, `handleProgressBarClick()` の短縮形を展開
- 各関数の可読性と保守性を向上

#### コメントの更新
- 古いコメント（順番ハイライトモード時）を現在の実装に合わせて修正
- 関数目的の明確化

## 7. 更新履歴

### 2025/08/28
- **順番ハイライト機能の実装**
  - 🔄ボタンの削除（切り替え不要）
  - 常に句ハイライト + 文字ハイライトの同時表示
  - 読んでいる句だけハイライト（既読句はクリア）
  - 文字ハイライトを赤い四角から青色文字色変更に改善
  - `highlightVerse()` 関数で毎回ハイライトをクリアしてから再設定

- **コード最適化**
  - デバッグ用 `console.log` の全削除（約15箇所）
  - 関数の一貫性改善（短縮形関数の展開）
  - コメントの更新と整理
  - 不要なコードの削除

- **Git管理改善**
  - コミットメッセージを日本語で統一
  - 定期的なプッシュで変更履歴の管理

### 2025/08/27
- **UI/UX大幅改善**
  - ページ高さを句の長さに関係なく固定（最長ページ基準）
  - 句束の中央寄せ実装（句数が可変でも中央配置）
  - 縦方向余白の削減とレイアウト最適化
  - ウィンドウリサイズとモード切替時の動的再計算
  - `computeFixedPageHeight()` 関数と `.pageInner` ラッパーの導入

### 2025/08/25
- `shoshinge_prototype.html` の念仏和讃モードを修正
  - ページの構成を新しいレイアウトに変更。
  - 各ページに対応する画像表示を修正。
  - 画像切り替えロジックを、句ごとからページごとに変更。

