<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>正信偈アプリ main2（表示・ハイライト修正版）</title>
  <style>
    body {
      font-family: "Hiragino Mincho ProN", serif;
      margin: 0;
      padding: 20px;
      background: white;
    }

    #modeSelector {
      margin-bottom: 15px;
    }

    #modeSelector button {
      margin-right: 10px;
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
      /* ボタンらしさを出す */
    }

    #modeSelector button.active {
      /* アクティブなボタンを強調 */
      font-weight: bold;
      background-color: #e0e0e0;
    }

    .page {
      writing-mode: vertical-rl;
      text-orientation: upright;
      display: none;
      /* 初期状態では非表示 */
      flex-direction: column;
      align-items: center;
      justify-content: space-evenly;
      height: 75vh;
      /* 高さを少し調整 */
      font-size: 24px;
      padding: 20px;
      border: 1px solid #eee;
      /* ページの区切りを視覚化 */
      margin-bottom: 10px;
      /* ページ間のマージン */
    }

    .page.active {
      display: flex;
      /* アクティブなページのみ表示 */
    }

    #controls {
      margin-bottom: 10px;
      display: flex;
      /* コントロール類を横並び */
      align-items: center;
      /* 中央揃え */
      gap: 10px;
      /* 要素間のスペース */
    }

    #controls button {
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
    }

    #progressBarContainer {
      flex-grow: 1;
      /* プログレスバーが残りの幅を取る */
      height: 10px;
      background: #ccc;
      border-radius: 5px;
      /* 角丸 */
      overflow: hidden;
      /* 角丸のため */
      cursor: pointer;
      /* クリックでシーク可能にする準備 */
    }

    #progressBar {
      width: 0%;
      height: 100%;
      background: #4caf50;
      transition: width 0.1s linear;
      /* プログレスバーの動きを滑らかに */
    }

    .verse {
      padding: 5px 0;
      /* 句の上下に少し余白 */
      border-radius: 3px;
      /* ハイライトの角を丸く */
    }

    .highlight {
      background: #ffeb3b;
      /* ハイライト色 */
    }
  </style>
</head>

<body>

  <h1>正信偈アプリ</h1>

  <div id="modeSelector">
    <button id="btn-shoshinge" onclick="switchMode('shoshinge')" class="active">正信偈</button>
    <button id="btn-wasan" onclick="switchMode('wasan')">和讃</button>
  </div>

  <div id="controls">
    <button id="playBtn">▶️ 再生</button>
    <button id="pauseBtn">⏸️ 一時停止</button>
    <div id="progressBarContainer">
      <div id="progressBar"></div>
    </div>
  </div>

  <audio id="audio" src="audio/shoshinge.mp3"></audio>

  <div id="pagesContainer">
  </div>

  <script>
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressBar = document.getElementById('progressBar');
    const pagesContainer = document.getElementById('pagesContainer');
    const modeButtons = {
      shoshinge: document.getElementById('btn-shoshinge'),
      wasan: document.getElementById('btn-wasan')
    };

    let currentMode = 'shoshinge'; // 初期モード
    let pages = []; // .page 要素を保持する配列

    // --- 元のHTMLから verse データを取得 ---
    // ▼▼▼ この配列を新しいデータで置き換えてください ▼▼▼
    const originalPagesData = [
      // --- 正信偈 (shoshinge) ---
      { section: 'shoshinge', verses: [{ start: 7.1, end: 21.9, text: '帰命無量寿如来' }, { start: 21.9, end: 30.9, text: '南無不可思議光' }, { start: 30.9, end: 38.7, text: '法蔵菩薩因位時' }, { start: 38.7, end: 46.0, text: '在世自在王仏所' }] },
      { section: 'shoshinge', verses: [{ start: 46.0, end: 53.0, text: '覩見諸仏浄土因' }, { start: 53.0, end: 59.9, text: '国土人天之善悪' }, { start: 59.9, end: 66.9, text: '建立無上殊勝願' }, { start: 66.9, end: 73.4, text: '超発希有大弘誓' }] },
      { section: 'shoshinge', verses: [{ start: 73.4, end: 80.1, text: '五劫思惟之摂受' }, { start: 80.1, end: 86.9, text: '重誓名声聞十方' }, { start: 86.9, end: 93.7, text: '普放無量無辺光' }, { start: 93.7, end: 100.4, text: '無碍無対光炎王' }] },
      { section: 'shoshinge', verses: [{ start: 100.4, end: 107.0, text: '清浄歓喜智慧光' }, { start: 107.0, end: 113.7, text: '不断難思無称光' }, { start: 113.7, end: 120.2, text: '超日月光照塵刹' }, { start: 120.2, end: 126.8, text: '一切群生蒙光照' }] },
      { section: 'shoshinge', verses: [{ start: 126.8, end: 133.3, text: '本願名号正定業' }, { start: 133.3, end: 140.0, text: '至心信楽願為因' }, { start: 140.0, end: 146.5, text: '成等覚証大涅槃' }, { start: 146.5, end: 153.0, text: '必至滅度願成就' }] },
      { section: 'shoshinge', verses: [{ start: 153.0, end: 159.3, text: '如来所以興出世' }, { start: 159.3, end: 165.9, text: '唯説弥陀本願海' }, { start: 165.9, end: 172.3, text: '五濁悪時群生海' }, { start: 172.3, end: 178.7, text: '応信如来如実言' }] },
      { section: 'shoshinge', verses: [{ start: 178.7, end: 185.0, text: '能発一念喜愛心' }, { start: 185.0, end: 191.4, text: '不断煩悩得涅槃' }, { start: 191.4, end: 197.7, text: '凡聖逆謗斉廻入' }, { start: 197.7, end: 204.2, text: '如衆水入海一味' }] },
      { section: 'shoshinge', verses: [{ start: 204.2, end: 210.6, text: '摂取心光常照護' }, { start: 210.6, end: 217.1, text: '已能雖破無明闇' }, { start: 217.1, end: 223.5, text: '貪愛瞋憎之雲霧' }, { start: 223.5, end: 229.7, text: '常覆真実信心天' }] },
      { section: 'shoshinge', verses: [{ start: 229.7, end: 236.0, text: '譬如日光覆雲霧' }, { start: 236.0, end: 242.7, text: '雲霧之下明無闇' }, { start: 242.7, end: 248.7, text: '獲信見敬大慶喜' }, { start: 248.7, end: 254.9, text: '即横超截五悪趣' }] },
      { section: 'shoshinge', verses: [{ start: 254.9, end: 261.1, text: '一切善悪凡夫人' }, { start: 261.1, end: 267.4, text: '聞信如来弘誓願' }, { start: 267.4, end: 273.7, text: '仏言広大勝解者' }, { start: 273.7, end: 279.9, text: '是人名分陀利華' }] },
      { section: 'shoshinge', verses: [{ start: 279.9, end: 285.9, text: '弥陀仏本願念仏' }, { start: 285.9, end: 292.1, text: '邪見驕慢悪衆生' }, { start: 292.1, end: 298.3, text: '信楽受持甚以難' }, { start: 298.3, end: 304.4, text: '難中之難無過斯' }] },
      { section: 'shoshinge', verses: [{ start: 304.4, end: 310.6, text: '印度西天之論家' }, { start: 310.6, end: 319.8, text: '中夏日域之高僧' }, { start: 319.8, end: 325.8, text: '顕大聖興世正意' }, { start: 325.8, end: 331.9, text: '明如来本誓応機' }] },
      { section: 'shoshinge', verses: [{ start: 331.9, end: 338.1, text: '釈迦如来楞伽山' }, { start: 338.1, end: 347.2, text: '為衆告命南天竺' }, { start: 347.2, end: 353.3, text: '龍樹大士出於世' }, { start: 353.3, end: 359.3, text: '悉能摧破有無見' }] },
      { section: 'shoshinge', verses: [{ start: 359.3, end: 365.3, text: '宣説大乗無上法' }, { start: 365.3, end: 371.3, text: '証歓喜地生安楽' }, { start: 371.3, end: 377.3, text: '顕示難行陸路苦' }, { start: 377.3, end: 383.4, text: '信楽易行水道楽' }] },
      { section: 'shoshinge', verses: [{ start: 383.4, end: 389.5, text: '憶念弥陀仏本願' }, { start: 389.5, end: 398.6, text: '自然即時入必定' }, { start: 398.6, end: 404.7, text: '唯能常称如来号' }, { start: 404.7, end: 410.7, text: '応報大悲弘誓恩' }] },
      { section: 'shoshinge', verses: [{ start: 410.7, end: 416.7, text: '天親菩薩造論説' }, { start: 416.7, end: 422.9, text: '帰命無碍光如来' }, { start: 422.9, end: 429.0, text: '依修多羅顕真実' }, { start: 429.0, end: 434.9, text: '光闡横超大誓願' }] },
      { section: 'shoshinge', verses: [{ start: 434.9, end: 440.8, text: '広由本願力回向' }, { start: 440.8, end: 447.1, text: '為度群生彰一心' }, { start: 447.1, end: 453.1, text: '帰入功徳大宝海' }, { start: 453.1, end: 459.2, text: '必獲入大会衆数' }] },
      { section: 'shoshinge', verses: [{ start: 459.2, end: 465.2, text: '得至蓮華蔵世界' }, { start: 465.2, end: 471.2, text: '即証真如法性身' }, { start: 471.2, end: 477.2, text: '遊煩悩林現神通' }, { start: 477.2, end: 483.1, text: '入生死園示応化' }] },
      { section: 'shoshinge', verses: [{ start: 483.1, end: 489.1, text: '本師曇鸞梁天子' }, { start: 489.1, end: 495.3, text: '常向鸞処菩薩礼' }, { start: 495.3, end: 501.3, text: '三蔵流支授浄教' }, { start: 501.3, end: 507.2, text: '焚焼仙経帰楽邦' }] },
      { section: 'shoshinge', verses: [{ start: 507.2, end: 513.2, text: '天親菩薩論註解' }, { start: 513.2, end: 519.2, text: '報土因果顕誓願' }, { start: 519.2, end: 525.1, text: '往還回向由他力' }, { start: 525.1, end: 531.1, text: '正定之因唯信心' }] },
      { section: 'shoshinge', verses: [{ start: 531.1, end: 537.1, text: '惑染凡夫信心発' }, { start: 537.1, end: 543.2, text: '証知生死即涅槃' }, { start: 543.2, end: 549.3, text: '必至無量光明土' }, { start: 549.3, end: 555.3, text: '諸有衆生皆普化' }] },
      { section: 'shoshinge', verses: [{ start: 555.3, end: 561.3, text: '道綽決聖道難証' }, { start: 561.3, end: 567.5, text: '唯明浄土可通入' }, { start: 567.5, end: 573.6, text: '万善自力貶勤修' }, { start: 573.6, end: 579.5, text: '円満徳号勧専称' }] },
      { section: 'shoshinge', verses: [{ start: 579.5, end: 585.3, text: '三不三信誨慇懃' }, { start: 585.3, end: 591.5, text: '像末法滅同悲引' }, { start: 591.5, end: 597.8, text: '一生造悪値弘誓' }, { start: 597.8, end: 612.5, text: '至安養界証妙果' }] },
      { section: 'shoshinge', verses: [{ start: 612.5, end: 628.3, text: '善導独明仏正意' }, { start: 628.3, end: 637.4, text: '矜哀定散与逆悪' }, { start: 637.4, end: 645.5, text: '光明名号顕因縁' }, { start: 645.5, end: 652.7, text: '開入本願大智海' }] },
      { section: 'shoshinge', verses: [{ start: 652.7, end: 659.6, text: '行者正受金剛心' }, { start: 659.6, end: 666.4, text: '慶喜一念相応後' }, { start: 666.4, end: 673.1, text: '与韋提等獲三忍' }, { start: 673.1, end: 679.9, text: '即証法性之常楽' }] },
      { section: 'shoshinge', verses: [{ start: 679.9, end: 686.5, text: '源信広開一代教' }, { start: 686.5, end: 693.2, text: '偏帰安養勧一切' }, { start: 693.2, end: 699.8, text: '専雑執心判浅深' }, { start: 699.8, end: 706.4, text: '報化二土正弁立' }] },
      { section: 'shoshinge', verses: [{ start: 706.4, end: 712.9, text: '極重悪人唯称仏' }, { start: 712.9, end: 719.4, text: '我亦在彼摂取中' }, { start: 719.4, end: 725.8, text: '煩悩障眼雖不見' }, { start: 725.8, end: 732.2, text: '大悲無倦常照我' }] },
      { section: 'shoshinge', verses: [{ start: 732.2, end: 738.7, text: '本師源空明仏教' }, { start: 738.7, end: 745.1, text: '憐愍善悪凡夫人' }, { start: 745.1, end: 751.7, text: '真宗教証興片州' }, { start: 751.7, end: 757.9, text: '選択本願弘悪世' }] },
      { section: 'shoshinge', verses: [{ start: 757.9, end: 764.3, text: '還来生死輪転家' }, { start: 764.3, end: 770.9, text: '決以疑情為所止' }, { start: 770.9, end: 777.3, text: '速入寂静無為楽' }, { start: 777.3, end: 784.8, text: '必以信心為能入' }] },
      { section: 'shoshinge', verses: [{ start: 784.8, end: 796.5, text: '弘経大士宗師等' }, { start: 797.3, end: 809.2, text: '拯済無辺極濁悪' }, { start: 809.2, end: 821.1, text: '道俗時衆共同心' }, { start: 821.1, end: 827.0, text: '唯可信斯高僧説' }] },

      // --- 念仏和讃 (wasan) ---
      { section: 'wasan', verses: [{ start: 3.9, end: 12, text: '南無阿弥陀仏' }, { start: 12, end: 21.4, text: '南無阿弥陀仏' }, { start: 21.4, end: 29.7, text: '南無阿弥陀仏' }, { start: 29.7, end: 37.7, text: '南無阿弥陀仏' }] },
      { section: 'wasan', verses: [{ start: 37.7, end: 45.9, text: '南無阿弥陀仏' }, { start: 45.9, end: 54.3, text: '南無阿弥陀仏' }, { start: 54.3, end: 56.8, text: '南' }, { start: 56.8, end: 75.6, text: '彌陀成佛のこのかたは' }] }, // (一首目開始)
      { section: 'wasan', verses: [{ start: 75.6, end: 92, text: 'いまに十劫をへたまへり' }, { start: 92, end: 102.3, text: '法身の光輪きはもなく' }, { start: 108.7, end: 121.4, text: '世の盲冥をてらすなり' }, { start: 121.5, end: 129.5, text: '南無阿弥陀仏' }] },
      { section: 'wasan', verses: [{ start: 129.5, end: 137.2, text: '南無阿弥陀仏' }, { start: 137.2, end: 145.2, text: '南無阿弥陀仏' }, { start: 145.2, end: 153.4, text: '南無阿弥陀仏' }, { start: 153.4, end: 155.9, text: '南' }] },
      { section: 'wasan', verses: [{ start: 155.9, end: 173.7, text: '智慧の光明はかりなし' }, { start: 173.7, end: 187.8, text: '有量の諸相ことごとく' }, { start: 187.8, end: 203.2, text: '光暁かぶらぬものはなし' }, { start: 203.2, end: 215.5, text: '眞實明に帰命せよ' }] }, // (二首目開始)
      { section: 'wasan', verses: [{ start: 215.5, end: 223.3, text: '南無阿弥陀仏' }, { start: 223.3, end: 231.3, text: '南無阿弥陀仏' }, { start: 231.3, end: 239, text: '南無阿弥陀仏' }, { start: 239, end: 246.7, text: '南無' }] },
      { section: 'wasan', verses: [{ start: 246.7, end: 256.7, text: '阿弥陀仏' }, { start: 256.7, end: 264.5, text: '南無阿弥陀仏' }, { start: 264.5, end: 272, text: '南無阿弥陀仏' }, { start: 272, end: 280.4, text: '南無阿弥陀仏' }] },
      { section: 'wasan', verses: [{ start: 280.4, end: 287.6, text: '南無阿弥陀仏' }, { start: 287.6, end: 295, text: '南無阿弥陀仏' }, { start: 295, end: 302.6, text: '南無阿弥陀仏' }, { start: 302.6, end: 305.2, text: '南' }] },
      { section: 'wasan', verses: [{ start: 305.2, end: 326.5, text: '解脱の光輪きはもなし' }, { start: 326.5, end: 340.2, text: '光触かぶるものはみな' }, { start: 340.2, end: 353.2, text: '有無をはなるとのべたまふ' }, { start: 353.2, end: 365.5, text: '平等覚に帰命せよ' }] }, // (三首目開始)
      { section: 'wasan', verses: [{ start: 365.5, end: 372.9, text: '南無阿弥陀仏' }, { start: 372.9, end: 380.9, text: '南無阿弥陀仏' }, { start: 380.9, end: 387.9, text: '南無阿弥陀仏' }, { start: 387.9, end: 395.2, text: '南無阿弥陀仏' }] },
      { section: 'wasan', verses: [{ start: 395.2, end: 398.1, text: '南' }, { start: 398.1, end: 418.2, text: '光雲無碍如虚空' }, { start: 418.2, end: 427.4, text: '一切の有碍にさはりなし' }, { start: 427.8, end: 445.3, text: '光沢かふらぬものぞなき' }] }, // (四首目開始)
      { section: 'wasan', verses: [{ start: 445.4, end: 457.3, text: '難思議を帰命せよ' }, { start: 457.3, end: 464.8, text: '南無阿弥陀仏' }, { start: 464.8, end: 471.8, text: '南無阿弥陀仏' }, { start: 471.8, end: 483.2, text: '南無阿弥陀仏' }] },
      { section: 'wasan', verses: [{ start: 483.2, end: 495.4, text: '南無阿弥陀仏' }, { start: 495.4, end: 504.3, text: '南無阿弥陀仏' }, { start: 504.3, end: 512.3, text: '南無阿弥陀仏' }, { start: 512.3, end: 520.6, text: '南無阿弥陀仏' }] },
      { section: 'wasan', verses: [{ start: 520.6, end: 528.5, text: '南無阿弥陀仏' }, { start: 528.5, end: 536.1, text: '南無阿弥陀仏' }, { start: 536.1, end: 544.3, text: '南無阿弥陀仏' }, { start: 544.3, end: 546.5, text: '南' }] },
      { section: 'wasan', verses: [{ start: 546.5, end: 567.6, text: '清浄光明ならびなし' }, { start: 567.6, end: 581.4, text: '遇斯光のゆへなれば' }, { start: 581.4, end: 597.3, text: '一切の業繋ものぞこりぬ' }, { start: 597.3, end: 610, text: '畢竟依を帰命せよ' }] }, // (五首目開始)
      { section: 'wasan', verses: [{ start: 610, end: 617.7, text: '南無阿弥陀仏' }, { start: 617.7, end: 625.5, text: '南無阿弥陀仏' }, { start: 625.5, end: 633.2, text: '南無阿弥陀仏' }, { start: 633.2, end: 641.4, text: '南無阿弥陀仏' }] },
      { section: 'wasan', verses: [{ start: 641.4, end: 643.7, text: '南' }, { start: 643.7, end: 660.5, text: '佛光照曜最第一' }, { start: 660.5, end: 676.2, text: '光炎王仏となづけたり' }, { start: 676.2, end: 690.2, text: '三塗の黒闇ひらくなり' }] }, // (六首目開始)
      { section: 'wasan', verses: [{ start: 690.2, end: 703.4, text: '大応供を帰命せよ' }, { start: 704.4, end: 722.8, text: '願以此功徳' }, { start: 722.8, end: 733.5, text: '平等施一切' }, { start: 733.5, end: 743.9, text: '同発菩提心' }] }, // (回向句開始)
      { section: 'wasan', verses: [{ start: 743.9, end: 755.0, text: '往生安楽国' }] }, // (回向句終了)
    ];
    // ▲▲▲ この配列を新しいデータで置き換えてください ▲▲▲


    // --- ページ要素を動的に生成 ---
    function createPageElement(pageData) {
      const pageDiv = document.createElement('div');
      pageDiv.classList.add('page');
      pageDiv.dataset.section = pageData.section;

      pageData.verses.forEach(verseData => {
        const verseDiv = document.createElement('div');
        verseDiv.classList.add('verse');
        verseDiv.dataset.start = verseData.start;
        verseDiv.dataset.end = verseData.end;
        verseDiv.textContent = verseData.text;
        pageDiv.appendChild(verseDiv);
      });
      return pageDiv;
    }

    // --- 初期化処理 ---
    function initialize() {
      // 元のデータからページ要素を生成してコンテナに追加
      originalPagesData.forEach(pageData => {
        const pageElement = createPageElement(pageData);
        pagesContainer.appendChild(pageElement);
      });
      // 生成された .page 要素を NodeList として取得し、配列に変換
      pages = Array.from(pagesContainer.querySelectorAll('.page'));
      // 初期モード表示
      switchMode(currentMode);
    }


    // --- モード切り替え ---
    function switchMode(mode) {
      if (currentMode === mode && pages.some(p => p.classList.contains('active'))) {
        // すでに選択中のモードで、表示中のページがあれば何もしない
        return;
      }
      currentMode = mode;

      // 全ページのハイライト解除と非表示化
      pages.forEach(p => {
        p.classList.remove('active');
        p.style.display = 'none'; // display: none に変更
        p.querySelectorAll('.verse.highlight').forEach(v => v.classList.remove('highlight'));
      });

      // 対応するモードボタンをアクティブ表示
      Object.values(modeButtons).forEach(btn => btn.classList.remove('active'));
      if (modeButtons[mode]) {
        modeButtons[mode].classList.add('active');
      }

      // 新しいモードの最初のページを表示
      const firstPageOfMode = pages.find(p => p.dataset.section === mode);
      if (firstPageOfMode) {
        firstPageOfMode.classList.add('active');
        firstPageOfMode.style.display = 'flex'; // display: flex に変更
        // 必要であれば、最初のページが表示されるようにスクロール
        // firstPageOfMode.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // 再生中の場合、現在の時間に合わせてハイライトとページ表示を更新
      if (!audio.paused) {
        highlightVerse(audio.currentTime);
        updateActivePage();
      } else {
        // 停止中の場合、プログレスバーだけ0に戻すか、現在の位置を維持するか？
        // ここでは何もしない (停止位置を維持)
        // もし先頭に戻したいなら highlightVerse(0); updateActivePage(); を呼ぶ
      }
    }


    // --- 現在時刻に合致する句をハイライト ---
    function highlightVerse(currentTime) {
      // まず現在のモードの全バースのハイライトを解除
      pages.forEach(p => {
        if (p.dataset.section === currentMode) {
          p.querySelectorAll('.verse.highlight').forEach(v => v.classList.remove('highlight'));
        }
      });

      let highlightedVerse = null;
      // 現在のモードのバースのみをチェック
      pages.forEach(p => {
        if (p.dataset.section === currentMode) {
          p.querySelectorAll('.verse').forEach(v => {
            const start = parseFloat(v.dataset.start);
            const end = parseFloat(v.dataset.end);
            // currentTime が範囲内にあるかチェック
            if (!isNaN(start) && !isNaN(end) && currentTime >= start && currentTime < end) {
              v.classList.add('highlight');
              highlightedVerse = v; // ハイライトしたバースを記録
            }
          });
        }
      });
      return highlightedVerse; // ハイライトされた verse 要素を返す (なければ null)
    }


    // --- アクティブなページを更新 ---
    function updateActivePage(highlightedVerseElement) {
      let foundActivePage = false;
      pages.forEach(p => {
        if (p.dataset.section === currentMode) {
          // ページ内にハイライトされたバースが含まれているかチェック
          const containsHighlighted = highlightedVerseElement && p.contains(highlightedVerseElement);
          if (containsHighlighted) {
            p.classList.add('active');
            p.style.display = 'flex'; // 表示
            foundActivePage = true;
            // 該当ページが表示範囲外ならスクロール (中央揃えが良いか?)
            p.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); // nearest or center
          } else {
            p.classList.remove('active');
            p.style.display = 'none'; // 非表示
          }
        } else {
          // 異なるモードのページは常に非表示
          p.classList.remove('active');
          p.style.display = 'none';
        }
      });

      // もしハイライトされたバースがなく、アクティブなページもない場合 (曲の冒頭や末尾など)
      // 必要であれば、現在のモードの最初のページをアクティブにするなどの処理を追加
      if (!foundActivePage && currentMode) {
        const firstPage = pages.find(p => p.dataset.section === currentMode);
        // 再生中でなければ最初のページを表示したままにするか？など検討
        if (audio.paused && !highlightedVerseElement && firstPage && !firstPage.classList.contains('active')) {
          // 再生停止中で、ハイライトがなく、最初のページが非アクティブなら表示する
          // firstPage.classList.add('active');
          // firstPage.style.display = 'flex';
        } else if (!audio.paused && !highlightedVerseElement && audio.currentTime > 0 && firstPage) {
          // 再生中でハイライトがない場合（例：曲の終わり）
          // 最後のページを表示し続けるか、最初のページに戻すか？
          // 今は updateActivePage のロジックで非表示になる
        }
      }
    }


    // --- 再生・一時停止ボタン ---
    playBtn.addEventListener('click', () => {
      // 再生を試みる (ユーザー操作起因なので通常は許可される)
      const playPromise = audio.play();
      if (playPromise !== undefined) {
        playPromise.then(_ => {
          // 再生開始成功
          console.log("Audio playback started.");
        }).catch(error => {
          // 再生開始失敗 (自動再生ブロックなど)
          console.error("Audio playback failed:", error);
          // 必要であればユーザーに通知
          // alert("ブラウザの設定により音声の再生がブロックされました。サイトの設定を確認してください。");
        });
      }
    });
    pauseBtn.addEventListener('click', () => {
      audio.pause();
      console.log("Audio playback paused.");
    });


    // --- 音声再生時間の更新イベント ---
    audio.addEventListener('timeupdate', () => {
      // プログレスバー更新
      if (audio.duration) { // duration が取得できてから計算
        const percent = (audio.currentTime / audio.duration) * 100;
        progressBar.style.width = percent + '%';
      }
      // ハイライト更新 & アクティブページ更新
      const highlightedVerseElement = highlightVerse(audio.currentTime);
      updateActivePage(highlightedVerseElement);
    });

    // --- プログレスバーのクリックによるシーク ---
    progressBarContainer.addEventListener('click', (e) => {
      if (!audio.duration) return; // duration がないと計算不可

      const rect = progressBarContainer.getBoundingClientRect();
      const offsetX = e.clientX - rect.left; // コンテナの左端からのクリック位置
      const newTime = (offsetX / rect.width) * audio.duration;

      if (isFinite(newTime)) { // 計算結果が有限数か確認
        audio.currentTime = newTime;
        // シーク後すぐにハイライトとページを更新
        const highlightedVerseElement = highlightVerse(audio.currentTime);
        updateActivePage(highlightedVerseElement);
      }
    });

    // --- 音声読み込み完了時の処理 ---
    audio.addEventListener('loadedmetadata', () => {
      console.log("Audio metadata loaded. Duration:", audio.duration);
      // Duration が読み込めたら、初期状態のプログレスバーなどを設定可能
      progressBar.style.width = '0%'; // 初期化
    });

    // --- 音声ファイルのエラーハンドリング ---
    audio.addEventListener('error', (e) => {
      console.error("Error loading audio file:", audio.error);
      alert(`音声ファイルの読み込みに失敗しました。\nパス: ${audio.currentSrc}\nエラー: ${audio.error?.message || 'Unknown error'}`);
      // ここで再生ボタンを無効化するなどの処理を追加可能
      playBtn.disabled = true;
      pauseBtn.disabled = true;
    });

    // --- アプリケーション初期化 ---
    document.addEventListener('DOMContentLoaded', initialize);

  </script>

</body>

</html>